<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>US Census Block Group Hourly Population 2022</title>

  <!-- External Styles -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />

  <!-- External Libraries (CDNs) -->
  <!-- IMPORTANT: Load 3rd party libraries BEFORE ArcGIS JS to avoid "multipleDefine" AMD errors -->
  
  <!-- Pako for GZIP decompression -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Plotly.js for Charts -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <!-- ArcGIS Maps SDK -->
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: "Avenir Next", "Helvetica Neue", Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    #topBanner {
      flex: 0 0 60px;
      background: linear-gradient(135deg, #0079c1 0%, #004575 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 60;
      text-align: center;
      border-bottom: 1px solid #003052;
    }

    #viewDiv {
      flex: 1;
      width: 100%;
      padding: 0;
      margin: 0;
      overflow: hidden;
      position: relative;
    }

    /* Floating Events Panel */
    #eventsPanel {
      position: absolute;
      top: 130px; /* Adjusted for taller banner */
      right: 15px;
      width: 260px;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      z-index: 50;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #eventsHeader {
      background-color: #f3f3f3;
      padding: 10px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #eventsList {
      max-height: 300px;
      overflow-y: auto;
    }

    .event-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .event-item:hover {
      background-color: #f0f8ff;
    }

    .event-name {
      font-weight: bold;
      color: #0079c1;
      font-size: 0.95em;
    }

    .event-details {
      font-size: 0.8em;
      color: #666;
      margin-top: 4px;
    }

    .event-links {
      font-size: 0.75em;
      margin-top: 6px;
    }
    
    .event-links a {
      color: #0079c1;
      text-decoration: none;
    }
    
    .event-links a:hover {
      text-decoration: underline;
    }

    /* Bottom Panel Container */
    #infoPanel {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40%; /* Relative height */
      min-height: 300px;
      background-color: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      z-index: 50;
      display: flex;
      flex-direction: column;
    }

    #panelHeader {
      background-color: #0079c1;
      color: white;
      padding: 8px 15px;
      font-size: 1em;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 36px;
      flex-shrink: 0;
    }

    /* Main Content Area: Split Vertically (Controls Top, Chart Bottom) */
    #panelContent {
      flex: 1;
      display: flex;
      flex-direction: column; /* Changed to column */
      overflow: hidden;
      position: relative;
    }

    /* Controls Bar */
    #controlsContainer {
      width: 100%;
      padding: 10px 15px;
      background-color: #f4f4f4;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    /* Chart Area */
    #chartContainer {
      flex: 1;
      position: relative;
      background-color: #fff;
      padding: 5px;
      min-height: 0; /* Important for flex child scrolling/sizing */
    }

    #chartDiv {
      width: 100%;
      height: 100%;
    }

    /* UI Elements Styling */
    .info-group {
      display: flex;
      gap: 10px;
      align-items: center;
      border-right: 1px solid #ccc;
      padding-right: 15px;
    }

    .stat-label { font-weight: bold; color: #555; font-size: 0.9em; }
    .stat-value { color: #000; font-family: monospace; font-size: 0.95em;}

    select {
      padding: 5px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }

    .btn {
      background-color: #0079c1;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 0.9em;
      transition: background-color 0.2s;
    }

    .btn:hover {
      background-color: #005a8f;
    }

    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .hint-text {
      font-size: 0.8em;
      color: #666;
      margin-left: auto; /* Push to right */
      font-style: italic;
    }

    /* Select Tool Button */
    #selectToolBtn, #selectPolygonBtn {
      background-color: white;
      color: #6e6e6e;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      margin-bottom: 5px; /* Spacing between buttons */
    }
    #selectToolBtn:hover, #selectPolygonBtn:hover {
      background-color: #f3f3f3;
      color: #2e2e2e;
    }
    #selectToolBtn.active, #selectPolygonBtn.active {
      background-color: #0079c1;
      color: white;
    }

    /* Loading Overlay */
    #loadingOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      z-index: 100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0079c1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Top Banner -->
  <div id="topBanner">The First Large-Scale Fine-Grained Hourly Population Map</div>

  <div id="viewDiv"></div>
  
  <!-- Map Tool Custom Buttons -->
  <div id="selectionTools">
    <div id="selectToolBtn" class="esri-widget--button esri-widget" title="Select Multiple (Rectangle)">
      <span class="esri-icon-checkbox-unchecked"></span>
    </div>
    <div id="selectPolygonBtn" class="esri-widget--button esri-widget" title="Select Multiple (Polygon)">
      <span class="esri-icon-polygon"></span>
    </div>
  </div>

  <!-- Events Panel -->
  <div id="eventsPanel">
    <div id="eventsHeader">
      <span>Featured Places/Events</span>
    </div>
    <div id="eventsList">
      <!-- Top Event: Central Park -->
      <div class="event-item" onclick="app.loadEvent('360610143001', '07')">
        <div class="event-name">New York City Central Park</div>
        <div class="event-details">New York, NY (2022)</div>
        <div class="event-details">Reported daily visitor: 115,000</div>
        <div class="event-links">
          <a href="https://www.centralpark.com/" target="_blank" onclick="event.stopPropagation()">Place Info</a>
          &nbsp;|&nbsp;
          <a href="https://assets.centralparknyc.org/media/documents/AnnualReport_Inside_2022_Digital.pdf" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 1 -->
      <div class="event-item" onclick="app.loadEvent('280539503003', '04')">
        <div class="event-name">World Catfish Festival</div>
        <div class="event-details">Belzoni, MS (Apr 2, 2022)</div>
        <div class="event-details">Reported visitor: ~9,000</div>
        <div class="event-links">
          <a href="https://www.catfishcapitol.com/world-catfish-festival-3/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.facebook.com/worldcatfishfestival/photos/a.10152291380327403/10159722507842403/?type=3&locale=ms_MY&_rdr" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>
      
      <!-- Event 2 -->
      <div class="event-item" onclick="app.loadEvent('371010414006', '09')">
        <div class="event-name">Benson Mule Days</div>
        <div class="event-details">Benson, NC (Sep 24, 2022)</div>
        <div class="event-details">Reported visitor: 20,000-30,000</div>
        <div class="event-links">
          <a href="https://bensonmuledays.com/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.johnstoncountync.org/event/benson-mule-days/1500" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 3 -->
      <div class="event-item" onclick="app.loadEvent('480519703001', '09')">
        <div class="event-name">Kolache Festival</div>
        <div class="event-details">Caldwell, TX (Sep 10, 2022)</div>
        <div class="event-details">Reported visitor: >18,000</div>
        <div class="event-links">
          <a href="https://www.burlesoncountytx.com/kolache-fest/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.bctribune.com/news/attendance-soars-years-kolache-festival#:~:text=By%20News%20Staff%20on%20Wednesday,at%20this%20year's%20Kolache%20Festival" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 4 -->
      <div class="event-item" onclick="app.loadEvent('340090219003', '12')">
        <div class="event-name">West Cape May Christmas Parade</div>
        <div class="event-details">West Cape May, NJ (Dec 3, 2022)</div>
        <div class="event-details">Reported visitor: >10,000</div>
        <div class="event-links">
          <a href="https://www.capemay.com/calendar/events/the-west-cape-may-christmas-parade/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.capemay.com/blog/2022/12/photos-from-the-2022-west-cape-may-christmas-parade/" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 5 -->
      <div class="event-item" onclick="app.loadEvent('340350529011', '10')">
        <div class="event-name">Far Hills Race Meeting</div>
        <div class="event-details">Far Hills, NJ (Oct 15, 2022)</div>
        <div class="event-details">Reported visitor: ~30,000</div>
        <div class="event-links">
          <a href="https://farhillsrace.org/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://farhillsrace.org/a-full-recap-of-our-101st-running-at-far-hills-race-meeting/#:~:text=This%20year%2C%20nearly%2030%2C000%20people,%2C%20LifeCamp%2C%20and%20Bonnie%20Brae" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 6 -->
      <div class="event-item" onclick="app.loadEvent('130999603002', '03')">
        <div class="event-name">Peanut Proud Festival</div>
        <div class="event-details">Blakely, GA (Mar 26, 2022)</div>
        <div class="event-details">Reported historical visitor: 8,000-10,000</div>
        <div class="event-links">
          <a href="https://www.peanutproudfestival.com/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.walb.com/story/37692363/peanut-proud-festival-expecting-to-draw-large-numbers-to-blakely/#:~:text=BLAKELY%2C%20GA%20(WALB)%20%2D,All%20rights%20reserved" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>
      
      <!-- Event 7 -->
      <div class="event-item" onclick="app.loadEvent('540259505003', '07')">
        <div class="event-name">Alderson 4th of July</div>
        <div class="event-details">Alderson, WV (Jul 4, 2022)</div>
        <div class="event-details">Reported historical visitor: ~15,000</div>
        <div class="event-links">
          <a href="https://www.alderson4th.com/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.wvnstv.com/archives/alderson-set-to-kick-off-56th-annual-fourth-of-july-celebration/840193683/" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 8 -->
      <div class="event-item" onclick="app.loadEvent('090091901002', '09')">
        <div class="event-name">Guilford Fair</div>
        <div class="event-details">Guilford, CT (Sep 16-18, 2022)</div>
        <div class="event-details">Expected visitor: ~20,000</div>
        <div class="event-links">
          <a href="https://guilfordfair.org/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.ctinsider.com/shoreline/article/guilford-fair-2022-opens-with-help-of-volunteers-17441373.php" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 9 -->
      <div class="event-item" onclick="app.loadEvent('510110401004', '10')">
        <div class="event-name">Appomattox Railroad Festival</div>
        <div class="event-details">Appomattox, VA (Oct 7-9, 2022)</div>
        <div class="event-details">2024 expected visitor: 25,000</div>
        <div class="event-links">
          <a href="https://appomattoxrrfest.org/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://wset.com/news/local/appomattox-railroad-festival-celebrates-52nd-year-rides-games-entertainment-live-music-parades-train-exhibits-vendors-art-crafts-homemade-goods-food-veterans-memorial-activities-october-2024" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>

      <!-- Event 10 -->
      <div class="event-item" onclick="app.loadEvent('510731002033,510731002031', '04')">
        <div class="event-name">Gloucester Daffodil Festival</div>
        <div class="event-details">Gloucester, VA (Apr 2-3, 2022)</div>
        <div class="event-details">Reported visitor: >25,000</div>
        <div class="event-links">
          <a href="https://www.daffodilfestivalva.org/" target="_blank" onclick="event.stopPropagation()">Event Info</a>
          &nbsp;|&nbsp;
          <a href="https://www.wtkr.com/positivelyhr/more-than-25k-people-attended-to-gloucester-daffodil-festivals-return-organizers-say#:~:text=More%20than%2025K%20people%20attended%20first%20Gloucester%20Daffodil%20Festival%20since,event%2C%20which%20was%20in%202019" target="_blank" onclick="event.stopPropagation()">Verify Count</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Information Panel -->
  <div id="infoPanel">
    <div id="panelHeader">
      <span>Population Viewer</span>
      <span id="headerMsg" style="font-size: 0.8em; opacity: 0.9;">Select a Block Group on map</span>
    </div>

    <div id="panelContent">
      <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading data...</div>
      </div>

      <!-- Controls Bar -->
      <div id="controlsContainer">
        
        <!-- Info Group -->
        <div class="info-group">
          <span class="stat-label">CBG:</span>
          <span class="stat-value" id="dispGeoid">None</span>
        </div>

        <!-- Month Selector -->
        <div class="control-item">
          <label class="stat-label" for="monthSelect">Month:</label>
          <select id="monthSelect" disabled>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>

        <!-- Full Year Button -->
        <button id="btnFullYear" class="btn" disabled>
          Load Full Year
        </button>

        <!-- Plot Hints & Legend -->
        <div class="hint-text" style="display: flex; align-items: center; gap: 15px;">
           <div style="display: flex; align-items: center;" title="Light green background indicates weekends">
              <span style="width: 14px; height: 14px; background-color: #90EE90; opacity: 0.5; margin-right: 5px; border: 1px solid #ddd;"></span>
              <span>Weekend</span>
           </div>
           <span id="plotHint">Use Select Tool for area. Hold Shift for multi-click.</span>
        </div>
      </div>

      <!-- Chart Area -->
      <div id="chartContainer">
        <div id="chartDiv"></div>
      </div>

    </div>
  </div>

  <script>
    // Global app namespace for inline HTML onclick handlers
    // Initialize with a placeholder to prevent "not a function" errors before ArcGIS loads
    window.app = {
      loadEvent: function() {
        alert("The map is still loading. Please wait a moment and try again.");
      }
    };

    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/widgets/Home",
      "esri/widgets/Search",
      "esri/widgets/ScaleBar",
      "esri/widgets/Compass",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Expand",
      "esri/widgets/Sketch/SketchViewModel",
      "esri/layers/GraphicsLayer",
      "esri/core/reactiveUtils",
      "esri/rest/support/Query"
    ], function(WebMap, MapView, Home, Search, ScaleBar, Compass, BasemapGallery, Expand, SketchViewModel, GraphicsLayer, reactiveUtils, Query) {

      // Configuration
      const WEBMAP_ID = "972baa5c50794bc599d730d035a71dee";
      const DATA_URL_TEMPLATE = "https://huggingface.co/datasets/gladcolor/hourly_population_US/resolve/main/2022/{MM}/{COUNTY_FIPS}.csv.gz";
      
      // State
      let currentCbgFips = null;
      let currentCountyFips = null;
      let cbgLayer = null; // Reference to the layer for querying
      
      // Array to store currently selected Features (graphics)
      let selectedFeatures = []; 

      // DATA CACHE
      let dataCache = {
        countyFips: null,
        month: null,
        parsedData: null, 
        fields: null
      };

      // UI Elements
      const ui = {
        loading: document.getElementById("loadingOverlay"),
        loadingText: document.getElementById("loadingText"),
        fipsDisplay: document.getElementById("dispGeoid"),
        headerMsg: document.getElementById("headerMsg"),
        btnFullYear: document.getElementById("btnFullYear"),
        monthSelect: document.getElementById("monthSelect"),
        chartDiv: document.getElementById("chartDiv")
      };

      // 1. Initialize Map
      const webmap = new WebMap({
        portalItem: {
          id: WEBMAP_ID
        }
      });

      const view = new MapView({
        container: "viewDiv",
        map: webmap,
        padding: { bottom: 300, right: 0 }, 
        popup: {
          autoOpenEnabled: false 
        }
      });

      // Create GraphicsLayer for Sketch
      const sketchLayer = new GraphicsLayer();
      webmap.add(sketchLayer);

      // Add Map Tools
      view.ui.add(new Home({ view: view }), "top-left");
      
      // Add custom select buttons
      view.ui.add("selectToolBtn", "top-left");
      view.ui.add("selectPolygonBtn", "top-left");

      const searchWidget = new Search({ view: view });
      view.ui.add(searchWidget, "top-right");
      
      view.ui.add(new Compass({ view: view }), "top-left");
      view.ui.add(new ScaleBar({ view: view, unit: "dual" }), "bottom-right");

      // Add Basemap Gallery inside Expand Widget
      const bgExpand = new Expand({
        view: view,
        content: new BasemapGallery({
          view: view
        }),
        expandIcon: "basemap", 
        expandTooltip: "Select Basemap"
      });
      view.ui.add(bgExpand, "top-left");

      // Setup SketchViewModel
      const sketchViewModel = new SketchViewModel({
        view: view,
        layer: sketchLayer,
        polygonSymbol: {
          type: "simple-fill",
          color: [0, 121, 193, 0.2],
          outline: {
            color: [0, 121, 193, 1],
            width: 1
          }
        },
        defaultUpdateOptions: {
            tool: "reshape",
            toggleToolOnClick: false
        }
      });

      // Select Tool Button Click (Rectangle)
      const selectBtn = document.getElementById("selectToolBtn");
      const polygonBtn = document.getElementById("selectPolygonBtn");

      selectBtn.addEventListener("click", () => {
        if (selectBtn.classList.contains("active")) {
            sketchViewModel.cancel();
            selectBtn.classList.remove("active");
        } else {
            // Deactivate polygon if active
            if (polygonBtn.classList.contains("active")) {
                polygonBtn.classList.remove("active");
            }
            selectBtn.classList.add("active");
            sketchViewModel.create("rectangle");
        }
      });

      // Select Tool Button Click (Polygon)
      polygonBtn.addEventListener("click", () => {
        if (polygonBtn.classList.contains("active")) {
            sketchViewModel.cancel();
            polygonBtn.classList.remove("active");
        } else {
            // Deactivate rectangle if active
            if (selectBtn.classList.contains("active")) {
                selectBtn.classList.remove("active");
            }
            polygonBtn.classList.add("active");
            sketchViewModel.create("polygon");
        }
      });

      // Sketch Events
      sketchViewModel.on("create", async (event) => {
        if (event.state === "complete") {
          selectBtn.classList.remove("active");
          polygonBtn.classList.remove("active");
          
          // Perform Query
          selectCbgsByGeometry(event.graphic.geometry);
          
          // Clear sketch
          sketchLayer.removeAll();
        }
        if (event.state === "cancel") {
             selectBtn.classList.remove("active");
             polygonBtn.classList.remove("active");
        }
      });

      async function selectCbgsByGeometry(geometry) {
         if (!cbgLayer) return;
         
         const query = cbgLayer.createQuery();
         query.geometry = geometry;
         query.spatialRelationship = "intersects";
         query.returnGeometry = true;
         query.outFields = ["*"];
         
         ui.headerMsg.textContent = "Selecting features...";
         
         try {
             const results = await cbgLayer.queryFeatures(query);
             const graphics = results.features;
             
             if (graphics.length > 0) {
                 // Replace current selection
                 selectedFeatures = graphics;
                 
                 const geoids = graphics.map(g => g.attributes.GEOID || g.attributes.geoid || g.attributes.Geoid);
                 const currentMonth = ui.monthSelect.value || "01";
                 
                 handleCbgSelection(geoids, currentMonth);
                 highlightGraphic(graphics);
             } else {
                 ui.headerMsg.textContent = "No features found in selection.";
             }
         } catch (error) {
             console.error(error);
             ui.headerMsg.textContent = "Selection Error.";
         }
      }

      // FIX: Ensure attributes are loaded and get Layer Reference
      view.when(() => {
        const layer = webmap.layers.find(l => l.title && l.title.toLowerCase().includes("blockgroups"));
        if (layer) {
          layer.outFields = ["*"];
          cbgLayer = layer;
        } else {
          // Fallback find
          cbgLayer = webmap.allLayers.find(l => l.type === "feature");
          if(cbgLayer) cbgLayer.outFields = ["*"];
        }

        // AUTO-SELECT CENTRAL PARK ON LOAD
        if(cbgLayer) {
           // We use reactiveUtils to wait until view is not updating to ensure smoother zoom
           reactiveUtils.whenOnce(() => !view.updating).then(() => {
              // Load Central Park (July) as default
              // This call will use the overwritten app.loadEvent defined below
              if (window.app.loadEvent && typeof window.app.loadEvent === 'function') {
                  window.app.loadEvent('360610143001', '07'); 
              }
           });
        }
      });

      // 2. Interaction Logic
      view.on("click", async (event) => {
        const response = await view.hitTest(event);
        
        // Find result in our feature layer
        const hitResult = response.results.find(res => {
          const g = res.graphic;
          return g && g.attributes && (
            g.attributes.GEOID || 
            g.attributes.geoid || 
            g.attributes.Geoid
          );
        });

        if (hitResult) {
          const graphic = hitResult.graphic;
          const geoid = graphic.attributes.GEOID || graphic.attributes.geoid || graphic.attributes.Geoid;
          
          // Multi-select Logic
          // Check for modifier keys (Shift or Ctrl)
          const isModifier = event.native.shiftKey || event.native.ctrlKey || event.native.metaKey;

          if (isModifier) {
             // Toggle selection
             const existingIndex = selectedFeatures.findIndex(g => {
                 const gId = g.attributes.GEOID || g.attributes.geoid || g.attributes.Geoid;
                 return gId === geoid;
             });

             if (existingIndex > -1) {
                 // Remove if already selected
                 selectedFeatures.splice(existingIndex, 1);
             } else {
                 // Add to selection
                 selectedFeatures.push(graphic);
             }
          } else {
             // Single Select: Reset and select only new
             selectedFeatures = [graphic];
          }

          // If nothing selected (e.g. deselected last one), clear UI
          if (selectedFeatures.length === 0) {
              view.graphics.removeAll();
              ui.fipsDisplay.textContent = "None";
              return; // Do we clear chart? Maybe keep last? Let's just return.
          }

          // Gather IDs for data fetching
          const selectedIds = selectedFeatures.map(g => 
             g.attributes.GEOID || g.attributes.geoid || g.attributes.Geoid
          );

          // Pass the currently selected month to preserve it, defaulting to "01" if empty
          const currentMonth = ui.monthSelect.value || "01";
          
          // Handle Data Selection
          handleCbgSelection(selectedIds, currentMonth);
          
          // Highlight Features
          highlightGraphic(selectedFeatures);
        }
      });

      function highlightGraphic(graphics) {
        view.graphics.removeAll();
        
        // Handle single graphic or array of graphics
        const items = Array.isArray(graphics) ? graphics : [graphics];
        
        items.forEach(g => {
            const highlight = {
               geometry: g.geometry,
               symbol: {
                 type: "simple-fill",
                 color: [0, 255, 255, 0.2],
                 outline: { color: [0, 255, 255, 1], width: 2 }
               }
            };
            view.graphics.add(highlight);
        });
      }

      function handleCbgSelection(geoids, month = "01") {
        if (!geoids || geoids.length === 0) {
          console.warn("Invalid GEOID list");
          return;
        }

        // Ensure input is always an array
        const cbgArray = Array.isArray(geoids) ? geoids : [geoids];
        
        // Store globally
        currentCbgFips = cbgArray;
        
        // Extract county from the first CBG (Assuming all are in same county for now)
        currentCountyFips = cbgArray[0].substring(0, 5); 

        // Update UI
        if (cbgArray.length > 1) {
            ui.fipsDisplay.textContent = `${cbgArray.length} Selected`;
            ui.fipsDisplay.title = cbgArray.join(", ");
        } else {
            ui.fipsDisplay.textContent = cbgArray[0];
            ui.fipsDisplay.title = "";
        }
        
        ui.headerMsg.textContent = "Data Loaded";
        
        ui.btnFullYear.disabled = false;
        ui.monthSelect.disabled = false;
        ui.monthSelect.value = month; // Set dropdown to requested month
        
        // Fetch Data
        fetchDataForMonth(month, currentCountyFips, currentCbgFips);
      }

      // 3. Event Handling (Exposed to Global Scope)
      // overwrite the placeholder function with the real logic
      window.app.loadEvent = async (cbgInput, month) => {
        if (!cbgLayer) {
            console.warn("Layer not ready yet for loadEvent.");
            return;
        }

        // Parse input: can be single ID string or comma-separated string
        const cbgList = cbgInput.split(',').map(s => s.trim());

        // 1. Query the map layer to find the feature geometry
        const query = cbgLayer.createQuery();
        
        // Build OR clause for multiple IDs
        const whereClause = cbgList.map(id => `GEOID = '${id}' OR geoid = '${id}'`).join(" OR ");
        query.where = whereClause;
        
        query.returnGeometry = true;
        query.outFields = ["*"];

        ui.headerMsg.textContent = "Locating Event...";
        
        try {
            const results = await cbgLayer.queryFeatures(query);
            if (results.features.length > 0) {
                // Update the internal state selection so multi-select works after programmatic load
                selectedFeatures = results.features;

                // 2. Zoom to features (all of them)
                // MODIFIED: Use a fixed zoom level (13) even for multiple features to maintain consistency
                // Instead of relying on auto-extent for multiples which was too zoomed out
                await view.goTo({
                    target: results.features,
                    zoom: 13 
                });

                // 3. Highlight and Select
                highlightGraphic(results.features);
                handleCbgSelection(cbgList, month);
            } else {
                console.warn("Could not find Block Groups on the map: " + cbgInput);
                // Fallback: still try to load the chart data even if map doesn't find geometry
                handleCbgSelection(cbgList, month);
            }
        } catch (error) {
            console.error("Query failed", error);
            // Even if map query fails, try to load data
            handleCbgSelection(cbgList, month);
        }
      };

      // Handle Month Change
      ui.monthSelect.addEventListener("change", (e) => {
        if (currentCbgFips && currentCountyFips) {
          fetchDataForMonth(e.target.value, currentCountyFips, currentCbgFips);
        }
      });

      // 4. Data Fetching & Processing
      async function fetchDataForMonth(month, countyFips, targetCbgs) {
        // CHECK CACHE FIRST
        if (dataCache.parsedData && 
            dataCache.countyFips === countyFips && 
            dataCache.month === month) {
            
            console.log("Using cached data for county", countyFips);
            processParsedData(dataCache.parsedData, dataCache.fields, targetCbgs, month);
            return;
        }

        showLoading(true, `Fetching ${month}/2022 data...`);
        
        try {
          const url = DATA_URL_TEMPLATE
            .replace("{MM}", month)
            .replace("{COUNTY_FIPS}", countyFips);
          
          const response = await fetch(url);
          if (!response.ok) throw new Error(`Failed to download data: ${response.statusText}`);
          const arrayBuffer = await response.arrayBuffer();
          const textData = pako.inflate(new Uint8Array(arrayBuffer), { to: 'string' });
          
          Papa.parse(textData, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              // SAVE TO CACHE
              dataCache = {
                countyFips: countyFips,
                month: month,
                parsedData: results.data,
                fields: results.meta.fields
              };

              processParsedData(results.data, results.meta.fields, targetCbgs, month);
            },
            error: function(err) { throw new Error("CSV Parse Error: " + err.message); }
          });

        } catch (error) {
          console.error(error);
          alert("Error loading data: " + error.message);
          showLoading(false);
        }
      }

      function processParsedData(data, fields, targetCbgs, month) {
        // targetCbgs is array of IDs
        
        // Find all rows matching the IDs
        const rows = data.filter(r => targetCbgs.includes(r.CBG) || targetCbgs.includes(r["﻿CBG"]));

        if (rows.length === 0) {
          // Don't alert immediately if multi-selecting, as some might not have data yet? 
          // For now, consistent behavior:
          alert(`Selected CBGs not found in data file.`);
          showLoading(false);
          return;
        }

        const timeSeriesX = [];
        const timeSeriesY = [];

        // Aggregate data if multiple rows, otherwise just take single
        fields.forEach(field => {
          if (field.includes("2022-")) {
            let sum = 0;
            let hasData = false;
            
            rows.forEach(row => {
                const val = parseFloat(row[field]);
                if (!isNaN(val)) {
                    sum += val;
                    hasData = true;
                }
            });

            if (hasData) {
              timeSeriesX.push(field);
              timeSeriesY.push(sum);
            }
          }
        });

        const title = rows.length > 1 
            ? `Total Population (${rows.length} Block Groups): Month ${month}`
            : `Population: Month ${month}`;

        renderChart(timeSeriesX, timeSeriesY, title);
        showLoading(false);
      }

      // 5. Visualization (Plotly)
      function getWeekendShapes(xValues) {
        if (!xValues || xValues.length === 0) return [];
        
        const shapes = [];
        const startDate = new Date(xValues[0]);
        const endDate = new Date(xValues[xValues.length - 1]);
        
        let current = new Date(startDate);
        current.setHours(0,0,0,0);
        
        while (current <= endDate) {
          const day = current.getDay(); // 0=Sun, 6=Sat
          if (day === 6) {
             const startStr = current.toISOString().split('T')[0] + ' 00:00:00';
             const nextMon = new Date(current);
             nextMon.setDate(nextMon.getDate() + 2);
             const endStr = nextMon.toISOString().split('T')[0] + ' 00:00:00';

             shapes.push({
               type: 'rect',
               xref: 'x',
               yref: 'paper',
               x0: startStr,
               x1: endStr,
               y0: 0,
               y1: 1,
               fillcolor: '#90EE90',
               opacity: 0.2, 
               line: { width: 0 },
               layer: 'below'
             });
          }
          current.setDate(current.getDate() + 1);
        }
        return shapes;
      }

      function renderChart(xValues, yValues, title) {
        const trace = {
          x: xValues,
          y: yValues,
          type: 'scatter',
          mode: 'lines',
          line: { 
            color: '#0079c1', 
            width: 0.8 
          }, 
          name: 'Population'
        };

        const weekendShapes = getWeekendShapes(xValues);

        const layout = {
          title: { text: title, font: { size: 14 } },
          margin: { t: 30, r: 20, l: 40, b: 30 },
          xaxis: { 
            type: 'date',
            tickformat: '%b %d'
          },
          yaxis: { 
            title: 'Pop',
            fixedrange: false 
          },
          showlegend: false,
          shapes: weekendShapes,
          autosize: true,
          hovermode: 'closest'
        };

        const config = { 
          responsive: true, 
          displayModeBar: true,
          displaylogo: false,
          modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };

        Plotly.newPlot(ui.chartDiv, [trace], layout, config);
      }

      // 6. Full Year Logic
      ui.btnFullYear.addEventListener("click", async () => {
        if (!currentCountyFips || !currentCbgFips) return;

        ui.btnFullYear.disabled = true;
        ui.monthSelect.disabled = true; 
        ui.btnFullYear.textContent = "Loading...";
        
        const months = ["01","02","03","04","05","06","07","08","09","10","11","12"];
        const fullYearX = [];
        const fullYearY = [];

        showLoading(true, "Downloading full year (1/12)...");

        try {
          const promises = months.map(m => {
            const url = DATA_URL_TEMPLATE.replace("{MM}", m).replace("{COUNTY_FIPS}", currentCountyFips);
            return fetch(url)
              .then(res => {
                if(!res.ok) throw new Error(`Missing ${m}`);
                return res.arrayBuffer();
              })
              .then(buffer => {
                const text = pako.inflate(new Uint8Array(buffer), { to: 'string' });
                return { month: m, text: text };
              });
          });

          const results = await Promise.all(promises);
          showLoading(true, "Processing data...");

          results.forEach(res => {
            Papa.parse(res.text, {
              header: true,
              skipEmptyLines: true,
              complete: function(parsed) {
                // Find rows for all selected CBGs
                const rows = parsed.data.filter(r => currentCbgFips.includes(r.CBG) || currentCbgFips.includes(r["﻿CBG"]));
                
                if (rows.length > 0) {
                  parsed.meta.fields.forEach(field => {
                    if (field.includes("2022-")) {
                       let sum = 0;
                       let hasData = false;
                       rows.forEach(row => {
                           const val = parseFloat(row[field]);
                           if(!isNaN(val)) {
                               sum += val;
                               hasData = true;
                           }
                       });

                       if (hasData) {
                         fullYearX.push(field);
                         fullYearY.push(sum);
                       }
                    }
                  });
                }
              }
            });
          });

          const combined = fullYearX.map((date, i) => ({ date, val: fullYearY[i] }));
          combined.sort((a, b) => new Date(a.date) - new Date(b.date));

          const sortedX = combined.map(c => c.date);
          const sortedY = combined.map(c => c.val);

          const title = currentCbgFips.length > 1 
            ? `Total Population (${currentCbgFips.length} CBGs): Full Year 2022`
            : "Population: Full Year 2022";

          renderChart(sortedX, sortedY, title);
          ui.btnFullYear.textContent = "Full Year Loaded";

        } catch (err) {
          console.error(err);
          alert("Error loading full year: " + err.message);
          ui.btnFullYear.disabled = false;
          ui.monthSelect.disabled = false;
          ui.btnFullYear.textContent = "Load Full Year 2022 Data";
        } finally {
          showLoading(false);
        }
      });

      function showLoading(show, text = "Loading...") {
        ui.loading.style.display = show ? "flex" : "none";
        ui.loadingText.textContent = text;
      }
    });
  </script>
</body>
</html>